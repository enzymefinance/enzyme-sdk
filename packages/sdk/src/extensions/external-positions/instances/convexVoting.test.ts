import { CVX, EXTERNAL_POSITION_MANAGER, VOTE_LOCKED_CVX } from "../../../../tests/constants.js";
import { publicClientMainnet, sendTestTransaction, testActions, testClientMainnet } from "../../../../tests/globals.js";
import { ExternalPosition } from "../externalPositionTypes.js";
import { prepareUseExternalPosition } from "../prepareUseExternalPosition.js";
import {
  decodeConvexVotingClaimRewardsArgs,
  decodeConvexVotingDelegateArgs,
  decodeConvexVotingLockArgs,
  decodeConvexVotingRelockArgs,
  decodeConvexVotingWithdrawArgs,
} from "./convexVoting.js";
import { parseAbi, parseEther, stringToHex } from "viem";
import { expect, test } from "vitest";

const vaultProxy = "0x278C647F7cfb9D55580c69d3676938608C945ba8" as const;
const comptrollerProxy = "0x746de9838BB3D14f1aC1b78Bd855E48201F221a6" as const;
const vaultOwner = "0x0D947D68f583e8B23ff816df9ff3f23a8Cfd7496" as const;

const abiVoteLockedCvx = parseAbi([
  "function lockedBalanceOf(address user) view returns (uint256)",
  "function userLocks(address user, uint256 lockCounter) view returns (uint112 amount, uint112 boosted, uint32 unlockTime)",
] as const);

const abiSnapshotRegistry = parseAbi(["function delegation(address user, bytes32 id) view returns (address)"] as const);

test("prepare external position trade for Convex Voting lock should work correctly", async () => {
  await testClientMainnet.reset({
    blockNumber: 14913398n,
  });

  await testClientMainnet.setBalance({ address: vaultOwner, value: parseEther("1") });

  // Taken from tx 0xaede0fb1423e70b0d7863881757dd7327b59b8526f7a133d7746f3907bffc1ff
  const callArgs =
    "0x00000000000000000000000063784bbce68ca50118cd6e2b519a22d4d956476600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000000";

  const decodedCallArgs = decodeConvexVotingLockArgs(callArgs);

  await sendTestTransaction({
    clientNetwork: "mainnet",
    ...prepareUseExternalPosition({
      externalPositionManager: EXTERNAL_POSITION_MANAGER,
      callArgs: {
        type: ExternalPosition.ConvexVotingLock,
        ...decodedCallArgs,
      },
    }),
    account: vaultOwner,
    address: comptrollerProxy,
  });

  const lockedCvx = await publicClientMainnet.readContract({
    abi: abiVoteLockedCvx,
    address: VOTE_LOCKED_CVX,
    functionName: "lockedBalanceOf",
    args: [decodedCallArgs.externalPositionProxy],
  });

  expect(lockedCvx).toBe(1000000000000000000n);
});

test("prepare external position trade for Convex Voting relock should work correctly", async () => {
  await testClientMainnet.reset({
    blockNumber: 15581112n,
  });

  await testClientMainnet.setBalance({ address: vaultOwner, value: parseEther("1") });

  // Taken from tx 0x42baaab2485d48915ef01bf1e65952c96c9884892b83a882ee5a5638d7b1bc3a
  const callArgs =
    "0x00000000000000000000000063784bbce68ca50118cd6e2b519a22d4d9564766000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000";

  const decodedCallArgs = decodeConvexVotingRelockArgs(callArgs);

  await sendTestTransaction({
    clientNetwork: "mainnet",
    ...prepareUseExternalPosition({
      externalPositionManager: EXTERNAL_POSITION_MANAGER,
      callArgs: {
        type: ExternalPosition.ConvexVotingRelock,
        ...decodedCallArgs,
      },
    }),
    account: vaultOwner,
    address: comptrollerProxy,
  });

  // would revert if lock wouldn't exist
  const lockedNumber3 = await publicClientMainnet.readContract({
    abi: abiVoteLockedCvx,
    address: VOTE_LOCKED_CVX,
    functionName: "userLocks",
    args: [decodedCallArgs.externalPositionProxy, 2n],
  });

  expect(lockedNumber3).toBeTruthy();
});

test("prepare external position trade for Convex Voting withdraw should work correctly", async () => {
  await testClientMainnet.reset({
    blockNumber: 15639281n,
  });

  await testClientMainnet.setBalance({ address: vaultOwner, value: parseEther("1") });

  // Taken from tx 0x8049d7d7a922f6cc74c69017d893d2993e874c324dd96808641573e855776938
  const callArgs =
    "0x00000000000000000000000063784bbce68ca50118cd6e2b519a22d4d9564766000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000";

  const decodedCallArgs = decodeConvexVotingWithdrawArgs(callArgs);

  await sendTestTransaction({
    clientNetwork: "mainnet",
    ...prepareUseExternalPosition({
      externalPositionManager: EXTERNAL_POSITION_MANAGER,
      callArgs: {
        type: ExternalPosition.ConvexVotingWithdraw,
        ...decodedCallArgs,
      },
    }),
    account: vaultOwner,
    address: comptrollerProxy,
  });

  const lockedCvx = await publicClientMainnet.readContract({
    abi: abiVoteLockedCvx,
    address: VOTE_LOCKED_CVX,
    functionName: "lockedBalanceOf",
    args: [decodedCallArgs.externalPositionProxy],
  });

  expect(lockedCvx).toBe(800000000000000000n);
});

test("prepare external position trade for Convex Voting claim rewards should work correctly", async () => {
  await testClientMainnet.reset({
    blockNumber: 14897331n,
  });

  await testClientMainnet.setBalance({ address: vaultOwner, value: parseEther("1") });

  // Taken from tx 0xc28ce3df19009531f9a769a9b0bc12dc6ada8e43f91af8789bed626a3459392d
  const callArgs =
    "0x00000000000000000000000063784bbce68ca50118cd6e2b519a22d4d956476600000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000184000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000dbdb4d16eda451d0503b854cf79d55697f90c8df0000000000000000000000004e3fbd56cd56c3e72c1403e103b45db9da5b9d2b0000000000000000000000003432b6a60d23ca0dfca7761b7ab56459d9c964d0000000000000000000000000e80c0cd204d654cebe8dd64a4857cab6be8345a30000000000000000000000005a98fcbea516cf06857215779fd812ca3bef1b3200000000000000000000000001ba67aac7f75f647d94220cc98fb30fcc5105bf000000000000000000000000c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f000000000000000000000000af5191b0de278c7286d6c7cc6ab6bb8a73ba2cd6000000000000000000000000c7283b66eb1eb5fb86327f08e1b5816b0720212b000000000000000000000000674c6ad92fd080e4004b2312b45f796a192d27a000000000000000000000000062b9c7356a2dc64a1969e19c23e4f579f9810aa7000000000000000000000000feef77d3f69374f66429c91d732a244f074bdf740000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000007a000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000bc00000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000000fa000000000000000000000000000000000000000000000000000000000000011a000000000000000000000000000000000000000000000000000000000000013c0000000000000000000000000dbdb4d16eda451d0503b854cf79d55697f90c8df00000000000000000000000000000000000000000000000000000000000005670000000000000000000000000000000000000000000000000000caa6891caee20000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000cd2d86d596c9b06a07606c1037cb659720c39117804d3610592b59d17c5ba92e92df683bd050469d6f8abfb2d17ab5a9c16436491abe6c05b21db9f4b5ce90e1014cb626b05d93f31e804cfdbd1b4026b90aed9bb431702fa19c826fa5ecc405e85016dbde8d0955b0986d0aba635971b4d1e181b0d6f059e818d2328945d31672d3f787d92160612fdc8e02049c25596987da931208ca0239446950af77bfae44c31cec1c0c96c8ac757b281de22372a4d2e6b3aa466ca10c2a1423dea119ddef3581de705a81957fa54dbe4c589f8eeff8fa87b5de656e40a2d66f4831758c6009ce63abc58e9bb582c6274dc33151811cd503871075ebb5bf250972c92314c8d2d46f847fa42e7883bf59e26e0524beb8306945276923343a589075a9cfcb3c958817f49ca39c099b6aa5c34963ea549435fce374a1ee92a4224d1642eba812800404132c6c35d67f2b6008c8bb09922bb2d5de3257bb606727631c2050ba50223dd455440fb945a3c40f2ae308faa4bd5fb25e31a0ef5b8b4825f4e1fcc320000000000000000000000004e3fbd56cd56c3e72c1403e103b45db9da5b9d2b00000000000000000000000000000000000000000000000000000000000005a300000000000000000000000000000000000000000000000000052c968da0229d0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000c157ae4cfb290168fdcd11dbfa5c2c24cf711ac3b037f066697ea471fdd03572ec2f7c9bd6a1c4bbdecb3996be476274aff54b67900c1aa64b131e9a2e2b74ef5782511c7f729234b34e5a97d2f3fef2b00c6bdaaf4e023c4eddcfa192066ef037e6092c7ad2a314ac65a34bf0cb451cc2447daccd05ec72ad93638a7d51ecd345cedb5c735123193edc8e200fc8324c081c36d13c3611c503863dce293374fbab344030f44bb1e475cb21231e3af9785098dfd166c80a785f430cd2165abc9287016e8dfb8fddb8723ac09e70ddf53381090a0e0a901c7b7970c6ba120bc6d260155d8896b6efba8af09490c7292781db4cfd17c8eb152092fa518006806c003ce977b81ab6bdbfdeee04bbe8b26bbf23ddbad6e9a8b56118759ac6ec8610aefe31730be2ab40c36dda67d698bcd522771bec367bfb51d9249fd111a30dbadb44b5f5df758ba4dbbb1dd477984ef3d33c1ef860a113c65bf6e52959e84930d1985b2358a0bf92bf1bbdc30a51bb92b734a719abffd4f4580ceb2af2e096db22f0000000000000000000000003432b6a60d23ca0dfca7761b7ab56459d9c964d00000000000000000000000000000000000000000000000000000000000000548000000000000000000000000000000000000000000000000001255bd1655af930000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000c4b0b94ab24449f19ce3fc3d32b8e731ce3ef484af5c710771a492781805fceb1e8c8468263840255f2d5dcf4154dbb5193cd95f84952a50a6f745019ecbc7c5240df3632a819a056d7eb9506c43c7601557f43c40dd5f16668b5c1e5799f333924566a3067d63ad7ea7914d54373ba30468f30f540b1e5648be8440a95630b909ecd184b02e19e25ed7f7c8a0d3ea129c74796582307770dcf7b8fca326596330e18231a4bce8f3ca608ae7dda9dabc04c049e6fa354eafa4b13dd9a4f93045e041ed65d4b97617b68cbea3600bbaafa4ffb70b9bce20a0c8eac756461b7b7089f12ae5b5654cf976779c0ad97613f6aaa1768436f5db2a7324812f7201bbd2f28c11145aec7af2e5037299f1db5901c3ba189a56ef45fcab128eda379bc3e3cddd575c7b2c9b27b60315bc26e50d68d5341a606361daf55ef2bf174b444e768b3ff7636c2c7b6177fb46a4d74e87d937a2db0fe9094f1a20b1e27caa9d8373ebfcdb055b1acc8294f70c5a002797327721b4f26614233307464cd9233e1f873000000000000000000000000e80c0cd204d654cebe8dd64a4857cab6be8345a300000000000000000000000000000000000000000000000000000000000002120000000000000000000000000000000000000000000000001c48004d7ac7f6000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000b424acc41b8f7cf4cbc0abb1fdd49787ed3b0b45cdc520efb4c0cf50166983cbf30c72a7b3a7d0964a5fd439d2aa98b4147c7427d352105ccdbe6f11216da1641715397e5f35a4d7c83a56951de5bd36c8e3c86dbde304e2182288e7b9181e60f207e9a103e8625470407738df0a80e0fff8d44afdef98ff8373aa34de28b03ca3d2fff86535b860f6328b1eac6a9f586d937ced6a90eb7aa33a428b6415ca5f985cff5243a82e07edd95f0d0d0dcff254067cf01284b3b34e1df84363f4a23149faa5add39647419bd60d209ddb814fd6bcf89a9bf7d5e72afebd2893261d6568bb8529db559dd60ff3bd891644ad2d7187d81939d0b081939b2ce0280b405a27a97eaf73efdac7f72a9c3b38d18df8566917f86e1766f25255b16d3d60a13e58b729b78096846ededdb8c3ac24df55f5f722a1564983080388fea7a42a05d1a5e2a38524d08f350a6ca67f7d5577a8cba5dbe41978f62ba1e476731ad26cd010000000000000000000000005a98fcbea516cf06857215779fd812ca3bef1b32000000000000000000000000000000000000000000000000000000000000049300000000000000000000000000000000000000000000000000476298049bb3340000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000c63045ee5646e8b071c0fa1335d36891fa9c67b6a40d6f5fcac8a8284dd39720caebe3e1e2838d270d40851963968759942f3a207db78621a92287eef06391b4e374d5459f649d411ace5ab38d9a27f80aea809bdc82f8d7e00f6c3799aea2dd1c8fb96c10b4359e00a96cbac1f29f269c71e0ca22a258f4032f820063354baf85c679e2ad8f760446c390e5b31c9131fa92699e4e10899a9d2fa42b68fac5dff42a95009caa678bb61ba189956db1bab98b40879a58d05ae1141ff05d4389eac526606c3bd9d4fef5747d1ccb7d77b81fac54ee4d6a3d7484f78fe09652d5984a7fcb0ab20c3633e625d6627ca147dea2c738ccffcd88c42124b509c549d089389e201e1ddaf7e01eb24490f32f5972275e2267f0603d328a6a15d69fd51a4fa85e6f9fdd7b77b0b0a9691c72f92b740af1c31aa0633fe6ada8028fe99d8089687d37c43b00af0202fb2569c2613eddebf00d65533f253584126cdee8a3c1da623d07454b64f36e14078116165448b6e5be97aed8cdbac02acd6b3832032d85500000000000000000000000001ba67aac7f75f647d94220cc98fb30fcc5105bf00000000000000000000000000000000000000000000000000000000000002480000000000000000000000000000000000000000000000000000358b573b94830000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000b2dfb134486a23678e3d7102a2478733c829d62e3f4e78d66e70918986fa8262cdcd7a3c570ecd04b2d5c01361892eb75d24b4a0fe1115e14fb8a9ed4b44e5471478561e6892d7488650a3c8ec272589011033ab82c90a0b789a185b5350e87f66bf2fd20b83a62e86341b8fad32b579574f6ca889fb058c2fb8f3c68bf8f81a517da4e5e3604075b4e89e9393a56f15043300e8e338102d159bb15c279e16530bf96ae995759135f051443930ed7a32abff711ffa5a50b7d1a6ccf24e34c7420ebf3f2c2fb8345f406d75d9967bfdc885b813f15446354114f92aad77aec9b4e7458cc41f83b47336b4029b0bcda634d2cf73b93d21cb8e52ae5cc6d661cfe67d477885b70836287ffdc20f0e0df90dacb193a0ec9bf4b4240a75a58b16cd55ad19ef02114131f2cd98934e40011e39c816808d16e43f106e98d75544c2ad25016dffeb1db1adc15fad99678f4c0107250fa67394e7b24eaed332cc19984b9ce000000000000000000000000c011a73ee8576fb46f5e1c5751ca3b9fe0af2a6f0000000000000000000000000000000000000000000000000000000000000246000000000000000000000000000000000000000000000000000080819e2897a00000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000ada4ed0a4116aa899cb5fde14c8dcf7c6b828983aceec767ee346e98ab36bf74b5f674689515b884a2a0b2d8b006f955dff1f476518f26029f6825d6d711a021e0c8b357ec1c8bd8f6e219a7207f6fe6c852a735db79fecf434236cf6ec8b9d87f7023e45ae5de26e4341929235c59e4314b4743eb14cfc24dfb743561dd8c93e35db74f55a0953aa2152e23727e10b81bad9708ecab612e6ac6b5f789a349b4ddc34b156fd2276cf4a612b239d7ef36b148f17024c4d85bcabf25e4adf8dc3cb5125c7fd29747c38a2f75ce0d6d6f4e420bca6dc2dc10b4714c218da3cee61317d20228668dba256359b5cd53cd48c6a2fa87381540b4cb568d458e8301cabfc46c526131278d4a295733efd2a73a0264ca6bce25e902e796f9a7d6366dae782a7dd0a5a8552b08e1d922246405172411c4852f5f35e80f04968e613a6bbd52e000000000000000000000000af5191b0de278c7286d6c7cc6ab6bb8a73ba2cd600000000000000000000000000000000000000000000000000000000000002280000000000000000000000000000000000000000000000000000a92a7cf16a370000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000b3a9c68a92e9ebc4c061667286ac945185ea83dddcc4146420c819435acde561917b1008f86399c1c3a5f363a047ea7bbe35e43f8851b5a47dd5733d540224b55953e87b83b3958d600f6792b6f30dce0705a01726338afdf45fd51da02458c304640c05c0626e9081187696ab1c6fd550cf762697d02c62f129498419de6cb7e9c9f804e4904e8f3961b961dc6add90e40289b3977d06f05925d18fe2e8ae347604d2095113c5d1acf8fa56dffbbb843fee5e15a547f83f30ee856afda4abb01a1838b30914e4ec3e0e60efcb5bb709af87bde19e7bf4fa0ff5efbbca04c54812544578e50579f2d4dc99236ef89913411a8044a6b53951832a5341533e8cf57556950b4062cddaf71c9ce72e317a52a9dffeaabf33a89b543943e11e6d4c065e4a1970394a29750ee84efed1fd8fa9ac0c2ed52f1a7a4f15fd2fc392cad09dcb08d75661d1790d4105057d16f2e8b514d4c29fde1988038b43515c16c84dfb3000000000000000000000000c7283b66eb1eb5fb86327f08e1b5816b0720212b00000000000000000000000000000000000000000000000000000000000004ee00000000000000000000000000000000000000000000000000183516ce942a780000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000cb20c8e373d72c1d73ced74a57e1965d5af196c009f1e2d1b2544ea5baccbd1ad5854163023f3879e87c52c1b02999687ab43de02336139f69da157dc4497f963f758993dc9fa01a60656abcbca178a6b2c7be6a020a842f205fc74bf80631a78a8f253c382c13d2b60d743d0be651627d62a3790231cada1c8c8d81201812d7ef75fbefb48d9d58e1fd2dd49e630db17f456a925fd9c6f4216841e6196a0481384abf0cf007b5e4ae707c2d2ed473baff52a55302568e3e756d03cc2ee19c956f942d93053553cb932664f500c9a6ea07e78811d50609f5e0839059de3b293ec6a082b934fcee45aad2298f438058300eca40410dcca56179e996f8f6a7992294fdd6c7afcf88c5ef0253ce80d8f9fa2dfc044606ee9b49ffa219c0eb1c7f67ba1c5c6d2cdbe9e31108ee4e0e2eba80d06d246b50b377b245f3d01ad548983a1d7a04e365d2ead47e78ea75cfdb263de9c5b5ece3545e4411af13c8588159bf4f308115411ea6f94be08257c36eda6b1fdcfdefe072b92c620bbae33206c490e000000000000000000000000674c6ad92fd080e4004b2312b45f796a192d27a000000000000000000000000000000000000000000000000000000000000002a7000000000000000000000000000000000000000000000000001c99edd46195470000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000b30427942fa15caa562819a33c425b746b4a2fc829ae23eab089b17d649958f250e7c6404337cfb681f0be6c986ba7060669d474fe9a244f59c7af1ab0c15cedbdaaa1920cf502f565c094046330aafd220c4904040fa9dcf82a931f05bcc419fd92819f36013c45e5f9716fb9894ab51422b6c567a516076905a87ed46416cc3837998edfa8d3ef969b46e03cb21e820c777dc2ad32b1c2489cef21de688b9c67e50c67582ff125099a6326ec8cb4f4856bcc4e005bb05c838075c7bd70a24d8fd66c66b72284d8dc5f8869b588435e552120cb9b219c4a2039114a9f05f0f28a19b2632080c662a6934225d1635d777dbf3eef024687230d5e1da062ce516d92cad7823d9da46984e6427065099b4ecc89cb29945e606f34727f1240de765353be14839a595a7f37eecd87e0c96bd85ec4e6346279cffaad70ef6df6f46ad21836e5b33fdcb16f91256ef3d41a702627a6ed3d11471b73b74eadd33b1a81adc";

  const decodedCallArgs = decodeConvexVotingClaimRewardsArgs(callArgs);

  const cvxBalanceBeforeClaim = await testActions.getBalanceOf({
    token: CVX,
    account: vaultProxy,
  });

  await sendTestTransaction({
    clientNetwork: "mainnet",
    ...prepareUseExternalPosition({
      externalPositionManager: EXTERNAL_POSITION_MANAGER,
      callArgs: {
        type: ExternalPosition.ConvexVotingClaimRewards,
        ...decodedCallArgs,
      },
    }),
    account: vaultOwner,
    address: comptrollerProxy,
  });

  const cvxBalanceAfterClaim = await testActions.getBalanceOf({
    token: CVX,
    account: vaultProxy,
  });

  expect(cvxBalanceAfterClaim).toBeGreaterThan(cvxBalanceBeforeClaim);
});

test("prepare external position trade for Convex Voting delegate should work correctly", async () => {
  await testClientMainnet.reset({
    blockNumber: 14840493n,
  });

  await testClientMainnet.setBalance({ address: vaultOwner, value: parseEther("1") });

  // Taken from tx 0x7d259fc02d6708522061c707254deecbfd08c9268aefeb9a7cf83b9ebbc8f5af
  const callArgs =
    "0x00000000000000000000000063784bbce68ca50118cd6e2b519a22d4d9564766000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000de1e6a7ed0ad3f61d531a8a78e83ccddbd6e0c49";

  const decodedCallArgs = decodeConvexVotingDelegateArgs(callArgs);

  await sendTestTransaction({
    clientNetwork: "mainnet",
    ...prepareUseExternalPosition({
      externalPositionManager: EXTERNAL_POSITION_MANAGER,
      callArgs: {
        type: ExternalPosition.ConvexVotingDelegate,
        ...decodedCallArgs,
      },
    }),
    account: vaultOwner,
    address: comptrollerProxy,
  });

  const snapshotDelegateRegistry = "0x469788fE6E9E9681C6ebF3bF78e7Fd26Fc015446";

  const delegate = await publicClientMainnet.readContract({
    abi: abiSnapshotRegistry,
    address: snapshotDelegateRegistry,
    functionName: "delegation",
    args: [decodedCallArgs.externalPositionProxy, stringToHex("cvx.eth", { size: 32 })],
  });

  expect(delegate).toBe(decodedCallArgs.delegate);
});
